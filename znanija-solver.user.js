// ==UserScript==
// @name         Znanija Solver
// @namespace    http://tampermonkey.net/
// @version      1.0.0
// @description  Solves Znanija questions
// @author       scar17off
// @match        https://znanija.com/*
// @icon         https://znanija.com/favicon.ico
// @grant        none
// ==/UserScript==

(()=>{"use strict";class t{constructor(t){this.letters=t}async getAnswer(t){throw new Error("getAnswer must be implemented by provider")}}class e extends t{constructor(){super(),this.systemMessage='Ти бот для надання відповідей на запитання в znanija. \nВідповідай максимально коротко, без форматування та зайвих слів.\nНе використовуй списки, зірочки чи інші спеціальні символи.\nНе пиши "Відповідь:", "Ось відповідь:" тощо.\nНе розбивай текст на пункти.\n\nДля математичних задач та задач з фізики/хімії:\n1. Спочатку напиши "Дано:"\n2. Потім "Розв\'язання:"\n3. В кінці "Відповідь:"\n\nДля завдань з категоризації слів:\n1. Просто напиши номер категорії і слова через кому\n2. Кожну категорію з нового рядка\n3. Не додавай пояснень\n\nДля всіх інших типів задач - просто пиши відповідь без додаткових слів.\n\nПриклади:\nПитання: Put the words in the correct category: dog cat house apartment bird fish\n1. dog, cat\n2. house, apartment\n3. bird, fish\n\nПитання: Знайти площу трикутника зі сторонами 3, 4 та 5\nДано:\na = 3\nb = 4\nc = 5\n\nРозв\'язання:\np = (a + b + c)/2 = 6\nS = √(p(p-a)(p-b)(p-c))\nS = √(6(6-3)(6-4)(6-5))\nS = √(6·3·2·1) = 6\n\nВідповідь: 6 кв.од.\n\nПитання: What do people hang on their doors during Christmas?\nPeople hang wreaths on their doors during Christmas.\n\nЯкщо отримуєш питання з контекстом "Моя відповідь:", не пиши "Відповідь:" на початку, просто дай правильну відповідь.'}async getAnswer(t,e){const n=await fetch("https://gpt24-ecru.vercel.app/api/openai/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36"},body:JSON.stringify({messages:[{role:"system",content:this.systemMessage},{role:"user",content:t}],stream:!0,model:"gpt-4o",temperature:.7,presence_penalty:0,frequency_penalty:0,top_p:1})});if(!n.ok)throw new Error(`API request failed: ${n.statusText}`);const o=n.body.getReader();let s="",a="";for(;;){const{value:t,done:n}=await o.read();if(n)break;a+=(new TextDecoder).decode(t);const r=a.split("\n");a=r.pop()||"";for(const t of r)if(t.startsWith("data: ")){const n=t.slice(6);if("[DONE]"===n)continue;try{const t=JSON.parse(n);t.choices[0].delta.content&&(s+=t.choices[0].delta.content,e&&e(s))}catch(t){continue}}}return s}}!function(){const t=new e;let n="";function o(){return document.querySelector("#slate-editable")}function s(){n="";const t=o();t&&(t.focus(),t.dispatchEvent(new KeyboardEvent("keydown",{key:"a",code:"KeyA",ctrlKey:!0,bubbles:!0,cancelable:!0})),setTimeout((()=>{t.dispatchEvent(new KeyboardEvent("keydown",{key:"Backspace",code:"Backspace",bubbles:!0,cancelable:!0}))}),50))}async function a(t){const e=t.slice(n.length);n=t,e&&(function(t){const e=new ClipboardEvent("paste",{bubbles:!0,cancelable:!0,clipboardData:new DataTransfer});e.clipboardData.setData("text/plain",t);const n=o();n&&(n.focus(),n.dispatchEvent(e))}(e),await new Promise((t=>setTimeout(t,50))))}setTimeout((function(){const e=setInterval((()=>{document.querySelector("#gpt24-answer-button")?clearInterval(e):document.querySelector(".Toolbar__toolbar--I6NTy")&&(function(){const e=document.querySelector(".Toolbar__toolbar--I6NTy");if(!e)return;const n=document.createElement("div");n.className="sg-vertical-separator sg-vertical-separator--gray-50",n.setAttribute("role","separator"),n.setAttribute("aria-orientation","vertical"),n.style.marginRight="0px",e.appendChild(n);const r=(new DOMParser).parseFromString('\n            <div>\n                <div class="OutsideClickController-module__wrapper--3MKCa">\n                    <div data-testid="tooltip_container" class="Tooltip-module__brn-tooltip-container--za0fg">\n                        <div role="button" class="Tooltip-module__brn-tooltip-children--Wa25k" tabindex="-1">\n                            <button id="gpt24-answer-button" data-testid="rich_text_editor_toolbar_gpt24_button" \n                                class="sg-button sg-button--m sg-button--transparent sg-button--icon-only" \n                                aria-label="GPT24 Answer">\n                                <span class="sg-button__hover-overlay"></span>\n                                <span class="sg-button__icon sg-button__icon--m">\n                                    <div aria-hidden="true" class="sg-icon sg-icon--adaptive sg-icon--x24" \n                                        style="font-family: \'Roboto\', sans-serif; font-weight: bold; font-size: 14px; display: flex; align-items: center; justify-content: center;">\n                                        AI\n                                    </div>\n                                </span>\n                                <span class="sg-button__text"></span>\n                            </button>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        ',"text/html").body.firstChild;e.appendChild(r),r.querySelector("#gpt24-answer-button").addEventListener("click",(()=>{const e=function(){const t=document.querySelector('.brn-answer-editor-layer__aside-content[data-testid="answer_editor_layer_aside"]');if(!t)return null;const e=t.querySelector(".sg-text.sg-text--text-gray-70")?.innerText;return e?e.replace("Задание","").trim():null}();e&&(s(),async function(e){console.log("Processing question:",e);try{const n=o();if(!n)return;n.focus(),s(),await new Promise((t=>setTimeout(t,100)));const r=async t=>{await a(t)};await t.getAnswer(e,r)}catch(t){console.error("Error getting answer:",t),await a("Error: Failed to get answer")}}(e))}))}(),clearInterval(e))}),1e3)}),1e3)}()})();